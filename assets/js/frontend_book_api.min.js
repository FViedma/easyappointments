window.FrontendBookApi=window.FrontendBookApi||{},function(a){"use strict";var e,t,o=!1;function n(a,e,t){t=t||!1,o=!0;var n=Date.parse(e),i=new Date(n.getFullYear(),n.getMonth()+1,0).getDate();if(t&&!GlobalVariables.manageMode)for(var r=1;r<=i;r++){var l=new Date(n.getFullYear(),n.getMonth(),r);if(-1===a.indexOf(l.toString("yyyy-MM-dd"))){$("#select-date").datepicker("setDate",l),FrontendBookApi.getAvailableHours(l.toString("yyyy-MM-dd"));break}}a.length===i&&$("#available-hours").text(EALang.no_available_hours),$("#select-date .ui-datepicker-calendar td:not(.ui-datepicker-other-month)").each(function(e,t){n.set({day:e+1}),-1!==a.indexOf(n.toString("yyyy-MM-dd"))&&$(t).addClass("ui-datepicker-unselectable ui-state-disabled")}),o=!1}a.getAvailableHours=function(a){$("#available-hours").empty();var e=$("#select-service").val(),t=15,o=GlobalVariables.availableServices.find(function(a){return Number(a.id)===Number(e)});o&&(t=o.duration);var n=FrontendBook.manageMode?GlobalVariables.appointmentData.id:null,i=GlobalVariables.baseUrl+"/index.php/appointments/ajax_get_available_hours",r={csrfToken:GlobalVariables.csrfToken,service_id:$("#select-service").val(),provider_id:$("#select-provider").val(),selected_date:a,service_duration:t,manage_mode:FrontendBook.manageMode,appointment_id:n};$.post(i,r).done(function(e){if(e.length>0){var t=$("#select-provider").val();"any-provider"===t&&(t=GlobalVariables.availableProviders[0].id);var o=GlobalVariables.availableProviders.find(function(a){return Number(t)===Number(a.id)});if(!o)throw new Error("Could not find provider.");var n=o.timezone,i=$("#select-timezone").val(),r="regular"===GlobalVariables.timeFormat?"h:mm a":"HH:mm";e.forEach(function(e){var t=moment.tz(a+" "+e+":00",n).tz(i);$("#available-hours").append($("<button/>",{class:"btn btn-outline-secondary btn-block shadow-none available-hour",data:{value:e},text:t.format(r)}))}),FrontendBook.manageMode?$(".available-hour").removeClass("selected-hour").filter(function(){return $(this).text()===Date.parseExact(GlobalVariables.appointmentData.start_datetime,"yyyy-MM-dd HH:mm:ss").toString(r)}).addClass("selected-hour"):$(".available-hour:eq(0)").addClass("selected-hour"),FrontendBook.updateConfirmFrame()}else $("#available-hours").text(EALang.no_available_hours)})},a.registerAppointment=function(){var a=$(".captcha-text");if(a.length>0&&(a.closest(".form-group").removeClass("has-error"),""===a.val()))a.closest(".form-group").addClass("has-error");else{var e=JSON.parse($('input[name="post_data"]').val()),t={csrfToken:GlobalVariables.csrfToken,post_data:e};a.length>0&&(t.captcha=a.val()),GlobalVariables.manageMode&&(t.exclude_appointment_id=GlobalVariables.appointmentData.id);var o=GlobalVariables.baseUrl+"/index.php/appointments/ajax_register_appointment",n=$("<div/>");$.ajax({url:o,method:"post",data:t,dataType:"json",beforeSend:function(a,e){n.appendTo("body").css({background:"white",position:"fixed",top:"0",left:"0",height:"100vh",width:"100vw",opacity:"0.5"})}}).done(function(e){if(!1===e.captcha_verification)return $("#captcha-hint").text(EALang.captcha_is_wrong).fadeTo(400,1),setTimeout(function(){$("#captcha-hint").fadeTo(400,0)},3e3),$(".captcha-title button").trigger("click"),a.closest(".form-group").addClass("has-error"),!1;window.location.href=GlobalVariables.baseUrl+"/index.php/appointments/book_success/"+e.appointment_hash}).fail(function(a,e,t){$(".captcha-title button").trigger("click")}).always(function(){n.remove()})}},a.getUnavailableDates=function(a,i,r){if(!o&&a&&i){var l=FrontendBook.manageMode?GlobalVariables.appointmentData.id:null,s=GlobalVariables.baseUrl+"/index.php/appointments/ajax_get_unavailable_dates",d={provider_id:a,service_id:i,selected_date:encodeURIComponent(r),csrfToken:GlobalVariables.csrfToken,manage_mode:FrontendBook.manageMode,appointment_id:l};$.ajax({url:s,type:"GET",data:d,dataType:"json"}).done(function(a){e=a,t=r,n(a,r,!0)})}},a.applyPreviousUnavailableDates=function(){n(e,t)},a.saveConsent=function(a){var e=GlobalVariables.baseUrl+"/index.php/consents/ajax_save_consent",t={csrfToken:GlobalVariables.csrfToken,consent:a};$.post(e,t)},a.deletePersonalInformation=function(a){var e=GlobalVariables.baseUrl+"/index.php/privacy/ajax_delete_personal_information",t={csrfToken:GlobalVariables.csrfToken,customer_token:a};$.post(e,t).done(function(){window.location.href=GlobalVariables.baseUrl})},a.getPatientByCI=function(a,e){var t=GlobalVariables.baseUrl+"/index.php/Backend_api/ajax_get_patient_by_ci",o={patientCI:a,complement:e};$.ajax({url:t,type:"GET",data:o,dataType:"json"}).done(function(a){$("#form-message").text(a.HCL_APPAT+" "+a.HCL_APMAT),$("#button-next-1").prop("disabled",!1)}).fail(function(a,e,t){$("#form-message").text("usuario no registrado en el sistema")})}}(window.FrontendBookApi);