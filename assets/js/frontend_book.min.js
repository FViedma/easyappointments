/* ----------------------------------------------------------------------------
 * Easy!Appointments - Open Source Web Scheduler
 *
 * @package     EasyAppointments
 * @author      A.Tselegidis <alextselegidis@gmail.com>
 * @copyright   Copyright (c) 2013 - 2020, Alex Tselegidis
 * @license     http://opensource.org/licenses/GPL-3.0 - GPLv3
 * @link        http://easyappointments.org
 * @since       v1.0.0
* ---------------------------------------------------------------------------- */ window.FrontendBook=window.FrontendBook||{},function(e){"use strict";var t,a;e.manageMode=!1,e.initialize=function(e,r){e=e||!0,r=r||!1,GlobalVariables.displayCookieNotice&&(cookieconsent.initialise({palette:{popup:{background:"#ffffffbd",text:"#666666"},button:{background:"#429a82",text:"#ffffff"}},content:{message:EALang.website_using_cookies_to_ensure_best_experience,dismiss:"OK"}}),$(".cc-link").replaceWith($("<a/>",{"data-toggle":"modal","data-target":"#cookie-notice-modal",href:"#",class:"cc-link",text:$(".cc-link").text()}))),FrontendBook.manageMode=r,tippy("[data-tippy-content]");var i=GeneralFunctions.getWeekDayId(GlobalVariables.firstWeekday),n=GlobalVariables.maxReservationPeriod;if($("#select-date").datepicker({dateFormat:"dd-mm-yy",firstDay:i,minDate:0,maxDate:"+"+n/5+"w",defaultDate:Date.today(),dayNames:[EALang.sunday,EALang.monday,EALang.tuesday,EALang.wednesday,EALang.thursday,EALang.friday,EALang.saturday],dayNamesShort:[EALang.sunday.substr(0,3),EALang.monday.substr(0,3),EALang.tuesday.substr(0,3),EALang.wednesday.substr(0,3),EALang.thursday.substr(0,3),EALang.friday.substr(0,3),EALang.saturday.substr(0,3)],dayNamesMin:[EALang.sunday.substr(0,2),EALang.monday.substr(0,2),EALang.tuesday.substr(0,2),EALang.wednesday.substr(0,2),EALang.thursday.substr(0,2),EALang.friday.substr(0,2),EALang.saturday.substr(0,2)],monthNames:[EALang.january,EALang.february,EALang.march,EALang.april,EALang.may,EALang.june,EALang.july,EALang.august,EALang.september,EALang.october,EALang.november,EALang.december],prevText:EALang.previous,nextText:EALang.next,currentText:EALang.now,closeText:EALang.close,onSelect:function(e,t){FrontendBookApi.getAvailableHours($(this).datepicker("getDate").toString("yyyy-MM-dd")),FrontendBook.updateConfirmFrame()},onChangeMonthYear:function(e,t,a){var r=new Date(e,t-1,1);FrontendBookApi.getUnavailableDates($("#select-provider").val(),$("#select-service").val(),r.toString("yyyy-MM-dd"))}}),$("#select-timezone").val(Intl.DateTimeFormat().resolvedOptions().timeZone),e&&($("#select-answer").on("change",function(){var e=$("#select-answer").find(":selected").val();switch(e){case"0":$("#select-municipality").prop("disabled",!0),$("select-medical-center").prop("disabled",!0),$("#doctor-name").prop("disabled",!0),$("#diagnostic").prop("disabled",!0),$("#doctor-name").prop("disabled",!0);break;case"1":$("#select-municipality").prop("disabled",!1),$("#diagnostic").prop("disabled",!1),$("#doctor-name").prop("disabled",!1);break;default:$("#select-municipality").prop("disabled",!0),$("#select-medical-center").prop("disabled",!0),$("#diagnostic").prop("disabled",!0),$("#doctor-name").prop("disabled",!0)}}),$("#select-municipality").on("change",function(){var e=$("#select-municipality").val();$("#select-medical-center").empty(),GlobalVariables.availableMedicalCenters.forEach(function(t){(t.codmunicip==e)>0&&$("#select-medical-center").append(new Option(t.nomestabl))}),$("#select-medical-center").prop("disabled",!1)}),$("#select-timezone").on("change",function(){var e=$("#select-date").datepicker("getDate");e&&(FrontendBookApi.getAvailableHours(e.toString("yyyy-MM-dd")),FrontendBook.updateConfirmFrame())}),$("#select-provider").on("change",function(){FrontendBookApi.getUnavailableDates($(this).val(),$("#select-service").val(),$("#select-date").datepicker("getDate").toString("yyyy-MM-dd")),FrontendBook.updateConfirmFrame()}),$("#select-service").on("change",function(){var e,t,a,r=$("#select-service").val();$("#select-provider").empty(),GlobalVariables.availableProvidersReservation.forEach(function(e){e.services.filter(function(e){return Number(e)===Number(r)}).length>0&&$("#select-provider").append(new Option(e.first_name+" "+e.last_name,e.id))}),FrontendBookApi.getUnavailableDates($("#select-provider").val(),$(this).val(),$("#select-date").datepicker("getDate").toString("yyyy-MM-dd")),FrontendBook.updateConfirmFrame(),e=r,(t=$("#service-description")).empty(),(a=GlobalVariables.availableServices.find(function(t){return Number(t.id)===Number(e)}))&&($("<strong/>",{text:a.name}).appendTo(t),a.description&&($("<br/>").appendTo(t),$("<span/>",{text:a.description}).appendTo(t)),(a.duration||Number(a.price)>0||a.location)&&$("<br/>").appendTo(t),a.duration&&$("<span/>",{text:"["+EALang.duration+" "+a.duration+" "+EALang.minutes+"]"}).appendTo(t),a.location&&$("<span/>",{text:"["+EALang.location+" "+a.location+"]"}).appendTo(t))}),$("#button-verify-ci").on("click",function(){if(function e(){$("#wizard-frame-1 .has-error").removeClass("has-error"),$("#wizard-frame-1 label.text-danger").removeClass("text-danger");try{var t=!1,a=$("#patient-ci").val();if(""==a&&($("#patient-ci").parents(".form-group").addClass("has-error"),t=!0),t)throw $("#appointment-message").empty(),$("#button-reprint").prop("disabled",!0),Error(EALang.fields_are_required);if(!GeneralFunctions.validateNumber($("#patient-ci").val()))throw $("#patient-ci").parents(".form-group").addClass("has-error"),$("#appointment-message").empty(),$("#button-reprint").prop("disabled",!0),Error(EALang.invalid_ci_number);return!0}catch(r){return $("#button-next-1").prop("disabled",!0),$("#form-message").text(r.message),!1}}()){var e=$("#patient-ci").val(),t=$("#complement").val();FrontendBookApi.getPatientByCI(e,t)}}),$("#button-reprint").on("click",function(){var e=$("#patient-ci").val(),t=$("#complement").val();$("#book_datetime").val(),FrontendBookApi.reprintTicket(e,t)}),$(".button-next").on("click",function(){if("2"===$(this).attr("data-step_index")){if(!function e(){$("#wizard-frame-2 .has-error").removeClass("has-error"),$("#wizard-frame-2 label.text-danger").removeClass("text-danger");try{var t=$("#select-answer"),a=!1;switch(t.val()){case"-1":t.parents(".form-group").addClass("has-error"),t.parents(".form-check").addClass("text-danger"),a=!0;break;case"0":break;case"1":$("#wizard-frame-2 .required").each(function(e,t){$(t).val()||($(t).parents(".form-group").addClass("has-error"),$(t).parents(".form-check").addClass("text-danger"),a=!0)})}if(a)throw Error(EALang.fields_are_required);return!0}catch(r){return $("#form-message").text(r.message),!1}}())return;$("#first-name").val($("#nombre_paciente").val()),$("#last-name").val($("#ape_paciente").val())}if("3"!==$(this).attr("data-step_index")||$("#select-provider").val()){if("4"===$(this).attr("data-step_index")&&!$(".selected-hour").length){$("#select-hour-prompt").length||$("<div/>",{id:"select-hour-prompt",class:"text-danger mb-4",text:EALang.appointment_hour_missing}).prependTo("#available-hours");return}if("5"===$(this).attr("data-step_index")){if(!function e(){$("#wizard-frame-5 .has-error").removeClass("has-error"),$("#wizard-frame-5 label.text-danger").removeClass("text-danger");try{var t=!1;if($("#wizard-frame-5 .required").each(function(e,a){$(a).val()||($(a).parents(".form-group").addClass("has-error"),t=!0)}),t)throw Error(EALang.fields_are_required);var a=$("#accept-to-terms-and-conditions");if(a.length&&!a.prop("checked"))throw a.parents(".form-check").addClass("text-danger"),Error(EALang.fields_are_required);var r=$("#accept-to-privacy-policy");if(r.length&&!r.prop("checked"))throw r.parents(".form-check").addClass("text-danger"),Error(EALang.fields_are_required);if(!GeneralFunctions.validateEmail($("#email").val()))throw $("#email").parents(".form-group").addClass("has-error"),Error(EALang.invalid_email);return!0}catch(i){return $("#form-message").text(i.message),!1}}())return;FrontendBook.updateConfirmFrame();var e=$("#accept-to-terms-and-conditions");if(e.length&&!0===e.prop("checked")){var r={first_name:$("#first-name").val(),last_name:$("#last-name").val(),email:$("#email").val(),type:"terms-and-conditions"};JSON.stringify(r)!==JSON.stringify(t)&&(t=r,FrontendBookApi.saveConsent(t))}var i=$("#accept-to-privacy-policy");if(i.length&&!0===i.prop("checked")){var n={first_name:$("#first-name").val(),last_name:$("#last-name").val(),email:$("#email").val(),type:"privacy-policy"};JSON.stringify(n)!==JSON.stringify(a)&&(a=n,FrontendBookApi.saveConsent(a))}}var s=parseInt($(this).attr("data-step_index"))+1;$(this).parents().eq(1).hide("fade",function(){$(".active-step").removeClass("active-step"),$("#step-"+s).addClass("active-step"),$("#wizard-frame-"+s).show("fade")})}}),$(".button-back").on("click",function(){var e=parseInt($(this).attr("data-step_index"))-1;$(this).parents().eq(1).hide("fade",function(){$(".active-step").removeClass("active-step"),$("#step-"+e).addClass("active-step"),$("#wizard-frame-"+e).show("fade")})}),$("#available-hours").on("click",".available-hour",function(){$(".selected-hour").removeClass("selected-hour"),$(this).addClass("selected-hour"),FrontendBook.updateConfirmFrame()}),FrontendBook.manageMode&&($("#cancel-appointment").on("click",function(e){var t=[{text:EALang.cancel,click:function(){$("#message-box").dialog("close")}},{text:"OK",click:function(){if(""===$("#cancel-reason").val()){$("#cancel-reason").css("border","2px solid #DC3545");return}$("#cancel-appointment-form textarea").val($("#cancel-reason").val()),$("#cancel-appointment-form").submit()}}];return GeneralFunctions.displayMessageBox(EALang.cancel_appointment_title,EALang.write_appointment_removal_reason,t),$("<textarea/>",{class:"form-control",id:"cancel-reason",rows:"3",css:{width:"100%"}}).appendTo("#message-box"),!1}),$("#delete-personal-information").on("click",function(){var e=[{text:EALang.cancel,click:function(){$("#message-box").dialog("close")}},{text:EALang.delete,click:function(){FrontendBookApi.deletePersonalInformation(GlobalVariables.customerToken)}}];GeneralFunctions.displayMessageBox(EALang.delete_personal_information,EALang.delete_personal_information_prompt,e)})),$("#book-appointment-submit").on("click",function(){FrontendBookApi.registerAppointment()}),$(".captcha-title button").on("click",function(e){$(".captcha-image").attr("src",GlobalVariables.baseUrl+"/index.php/captcha?"+Date.now())}),$("#select-date").on("mousedown",".ui-datepicker-calendar td",function(e){setTimeout(function(){FrontendBookApi.applyPreviousUnavailableDates()},300)})),FrontendBook.manageMode)(function e(t,a,r){try{$("#select-service").val(t.id_services).trigger("change"),$("#select-provider").val(t.id_users_provider),$("#select-date").datepicker("setDate",Date.parseExact(t.start_datetime,"yyyy-MM-dd HH:mm:ss")),FrontendBookApi.getAvailableHours(moment(t.start_datetime).format("YYYY-MM-DD")),$("#last-name").val(r.last_name),$("#first-name").val(r.first_name),$("#email").val(r.email),$("#phone-number").val(r.phone_number),$("#address").val(r.address),$("#city").val(r.city),$("#zip-code").val(r.zip_code),r.timezone&&$("#select-timezone").val(r.timezone);var i=null!==t.notes?t.notes:"";return $("#notes").val(i),FrontendBook.updateConfirmFrame(),!0}catch(n){return!1}})(GlobalVariables.appointmentData,GlobalVariables.providerData,GlobalVariables.customerData);else{var s=$("#select-provider"),o=$("#select-service"),l=GeneralFunctions.getUrlParameter(location.href,"service");l&&o.find('option[value="'+l+'"]').length>0&&o.val(l),o.trigger("change");var c=GeneralFunctions.getUrlParameter(location.href,"provider");if(c&&0===s.find('option[value="'+c+'"]').length)for(var d in GlobalVariables.availableProvidersReservation){var p=GlobalVariables.availableProvidersReservation[d];p.id===c&&p.services.length>0&&o.val(p.services[0]).trigger("change")}c&&s.find('option[value="'+c+'"]').length>0&&s.val(c).trigger("change")}},e.updateConfirmFrame=function(){if(""!==$(".selected-hour").text()){var e=$("#select-date").datepicker("getDate");null!==e&&(e=GeneralFunctions.formatDate(e,GlobalVariables.dateFormat));var t=$("#select-service").val(),a="";GlobalVariables.availableServices.forEach(function(e,r){if(Number(e.id)===Number(t)&&Number(e.price)>0)return a=e.currency,!1}),$("#appointment-details").empty(),$("<div/>",{html:[$("<h4/>",{text:EALang.appointment}),$("<p/>",{html:[$("<span/>",{text:EALang.service+": "+$("#select-service option:selected").text()}),$("<br/>"),$("<span/>",{text:EALang.provider+": "+$("#select-provider option:selected").text()}),$("<br/>"),$("<span/>",{text:EALang.start+": "+e+" "+$(".selected-hour").text()}),]})]}).appendTo("#appointment-details");var r=GeneralFunctions.escapeHtml($("#first-name").val()),i=GeneralFunctions.escapeHtml($("#last-name").val()),n=GeneralFunctions.escapeHtml($("#phone-number").val()),s=GeneralFunctions.escapeHtml($("#email").val()),o=GeneralFunctions.escapeHtml($("#address").val()),l=GeneralFunctions.escapeHtml($("#city").val()),c=GeneralFunctions.escapeHtml($("#zip-code").val()),d=GeneralFunctions.escapeHtml($("#select-answer").val()),p=GeneralFunctions.escapeHtml($("#select-answer option:selected").text()),m=GeneralFunctions.escapeHtml($("#select-municipality").val()),v=GeneralFunctions.escapeHtml($("#select-municipality option:selected").text()),u=GeneralFunctions.escapeHtml($("#select-medical-center").val()),f=GeneralFunctions.escapeHtml($("#doctor-name").val()),y=GeneralFunctions.escapeHtml($("#diagnostic").val()),g=GeneralFunctions.escapeHtml($("#select-service option:selected").text()),h=GeneralFunctions.escapeHtml($("#select-provider").text());$("#customer-details").empty(),$("<div/>",{html:[$("<h4/>)",{text:EALang.customer}),$("<p/>",{html:[$("<span/>",{text:EALang.customer+": "+r+" "+i}),$("<br/>"),$("<span/>",{text:EALang.phone_number+": "+n}),$("<br/>"),$("<span/>",{text:EALang.email+": "+s}),$("<br/>"),$("<span/>",{text:d>-1?EALang.reference+": "+p:""}),$("<br/>"),$("<span/>",{text:1==d?EALang.municipality+": "+v:""}),$("<br/>"),$("<span/>",{text:1==d?EALang.hospital+": "+u:""}),$("<br/>"),$("<span/>",{text:1==d?EALang.doctor_reference+": "+f:""}),$("<br/>"),$("<span/>",{text:1==d?EALang.diagnostic+": "+y:""}),$("<br/>"),$("<span/>",{text:o?EALang.address+": "+o:""}),$("<br/>"),$("<span/>",{text:l?EALang.city+": "+l:""}),$("<br/>"),$("<span/>",{text:c?EALang.zip_code+": "+c:""}),$("<br/>"),]})]}).appendTo("#customer-details");var b,x,k,w,C={};C.doctor={doctor_name:h,speciality:g},C.customer={last_name:$("#last-name").val(),first_name:$("#first-name").val(),email:$("#email").val(),phone_number:$("#phone-number").val(),address:$("#address").val(),city:$("#city").val(),birth_date:$("#birth-date").val().toString("yyyy-MM-dd"),timezone:$("#select-timezone").val(),user_ci:$("#patient-ci").val(),complement:$("#complement").val(),clinical_story:$("#clinic_story").val()},C.appointment={start_datetime:$("#select-date").datepicker("getDate").toString("yyyy-MM-dd")+" "+Date.parse($(".selected-hour").data("value")||"").toString("HH:mm")+":00",end_datetime:(x=$("#select-service").val(),k=GlobalVariables.availableServices.find(function(e){return Number(e.id)===Number(x)}),w=$("#select-date").datepicker("getDate").toString("dd-MM-yyyy")+" "+Date.parse($(".selected-hour").data("value")||"").toString("HH:mm"),w=Date.parseExact(w,"dd-MM-yyyy HH:mm"),(b=k.duration&&w?w.add({minutes:parseInt(k.duration)}):new Date).toString("yyyy-MM-dd HH:mm:ss")),notes:$("#diagnostic").val(),is_unavailable:!1,id_users_provider:$("#select-provider").val(),id_services:$("#select-service").val(),medic_refering:$("#doctor-name").val(),id_municipality:m,municipality:v,medical_center:$("#select-medical-center").val()},C.manage_mode=FrontendBook.manageMode,FrontendBook.manageMode&&(C.appointment.id=GlobalVariables.appointmentData.id,C.customer.id=GlobalVariables.customerData.id),$('input[name="csrfToken"]').val(GlobalVariables.csrfToken),$('input[name="post_data"]').val(JSON.stringify(C))}}}(window.FrontendBook);